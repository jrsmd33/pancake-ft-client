<!DOCTYPE html>
<html>
<head>
  <title>Pancake: Tester</title>
</head>
<body>
  <div id="container">
    <header data-bind="text: name"></header>
    <section>
      <p># ancestors: <span data-bind="text: ancestorsCount">-</span></p>
    </section>
  </div>

<script src="../js/config.js"></script>
<script src="../js/vendor/requirejs.js?v={{v}}"></script>
<script>
  config.appName = "main";
  console.log("bootstrapping for platform: ", config.platform, config);
  require({
    // configure our AMD loader
    baseUrl: '../js',
    packages: config.packages,
    paths: config.paths,
    waitSeconds: 20,
    urlArgs: "r={{v}}" // r is a cache-busting token
  }, ['lang', 'knockout', 'lib/knockout.composeWith'], function(util, ko){

    console.log("underscore: ", util);
    

    var nameStream = window.nameStream = ko.observableArray([{ name: "Bob" }, { name: "Dave"}, { name: "Adam"}]);
    nameStream.subscribe(function(values){
      console.log("nameStream event: ", values );
    });
    
    var nameReducer = function(prev, val, idx){
      console.log("nameReducer: ", prev, val, idx);
      return prev + ", son of " + val;
    };
    
    function curryPlucker(key) {
      return function(values) {
        return values.map(function(value){ 
          return value[key]; 
        });
      }
    }

    function logger(name) {
      return function(values) {
        console.log(name + " logger: got values: ", values);
        return values;
      };
    }
    
    var viewModel = window.viewModel = {
      name:  nameStream.extend({ 
        composeWith: [
          // logger('name field'), 
          curryPlucker('name'), 
          function(values) { 
            return values.reduce(nameReducer);
          },
          logger('post-name field') 
        ] 
      }),
      ancestorsCount: nameStream.extend({ 
        composeWith: [
          // logger('ancestorsCount field'), 
          util.tail, 
          util.size,
          logger('post-ancestorsCount field') 
        ]
      })
    };
    
    ko.applyBindings(viewModel, document.getElementById("container"));

  });
</script>

</body>
</html>
